<!DOCTYPE html>
<html lang="en">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="color-scheme" content="dark light">
        <link rel="icon" href="./favicon.png" type="image/png">
        <title>TV Streams - Debug mode</title>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
        <style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }
        .header h1 {
            color: #4a9eff;
            margin-bottom: 10px;
        }
        .header .subtitle {
            color: #888;
            font-size: 0.9em;
        }
        .stats-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #333;
        }
        .current-status {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        .current-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .current-led.loading {
            background: #ffa500;
            animation: pulse 1s infinite;
        }
        .current-led.success {
            background: #00ff00;
            box-shadow: 0 0 6px #00ff00;
        }
        .current-led.error {
            background: #ff4444;
            box-shadow: 0 0 6px #ff4444;
        }
        .current-text {
            font-weight: bold;
            font-size: 1.1em;
            flex-grow: 1;
        }
        .progress-info {
            color: #aaa;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .compact-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .stat-line {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }
        .stat-label {
            color: #aaa;
            width: 80px;
            font-weight: bold;
        }
        .stat-values {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-passed {
            color: #00ff00;
            font-weight: bold;
        }
        .stat-failed {
            color: #ff4444;
            font-weight: bold;
        }
        .stat-separator {
            color: #666;
        }
        .channels-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .channel-card {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #333;
        }
        .channel-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .channel-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: contain; 
            border: 2px solid #333;
            background: #252525;  
        } 
        .channel-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .channel-led.waiting {
            background: #ffa500;
            animation: pulse 1.5s infinite;
        }
        .channel-led.success {
            background: #00ff00;
            box-shadow: 0 0 6px #00ff00;
        }
        .channel-led.error {
            background: #ff4444;
            box-shadow: 0 0 6px #ff4444;
        }
        .channel-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #4a9eff;
            flex-grow: 1;
        }
        .channel-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px 20px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 13px;
        }
        @media (max-width: 600px) {
            .channel-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .detail-label {
                margin-top: 5px;
            }
        }
        .detail-label {
            color: #8cd0d3;
            font-weight: bold;
            white-space: nowrap;
        }
        .detail-value {
            color: #e0e0e0;
            word-break: break-all;
            background: #252525;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .detail-value.url {
            color: #ce9178;
        }
        .detail-value.icon {
            color: #b5cea8;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .hidden {
            display: none !important;
        }
        .icon-fallback {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: linear-gradient(135deg, #2d5aa0, #4a9eff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8em;
            border: 2px solid #333;
        }
        #debug-button {
            position: fixed;
            top: 16px;
            right: 16px;
            z-index: 1000;
            background: #1a1a21;
            border: 1px solid #3a3a4a;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }
        #debug-button-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
            filter: brightness(0.8) saturate(1.2);
            transition: filter 0.25s ease;
        }
        #debug-button:hover {
            background: #24242b;
            border-color: #4a4a5a;
            box-shadow: 
                0 4px 12px rgba(138, 138, 255, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.12);
        transform: translateY(-1px) scale(1.05);
        }
        #debug-button:hover #debug-button-icon {
            filter: brightness(1) saturate(1.5);
        }
        #debug-button:active {
            transform: translateY(0) scale(1);
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    </head>
    <body>
        <div class="header">
            <h1>Debug Mode</h1>
            <div class="subtitle">Testing streams sequentially • 5 second timeout per stream</div>
        </div>

        <div class="stats-container">
            <div class="current-status">
                <span class="current-led loading" id="current-led"></span>
                <span class="current-text" id="current-text">Initializing...</span>
                <span class="progress-info" id="progress-info">0/0</span>
            </div>

            <!-- COMPACT STATS -->
            <div class="compact-stats" id="compact-stats">
                <div class="stat-line">
                    <span class="stat-label">ID:</span>
                    <div class="stat-values">
                        <span class="stat-passed" id="id-passed-count">0</span>
                        <span class="stat-label">passed</span>
                        <span class="stat-separator">-</span>
                        <span class="stat-failed" id="id-failed-count">0</span>
                        <span class="stat-label">failed</span>
                    </div>
                </div>
                <div class="stat-line">
                    <span class="stat-label">ICON:</span>
                    <div class="stat-values">
                        <span class="stat-passed" id="icon-passed-count">0</span>
                        <span class="stat-label">passed</span>
                        <span class="stat-separator">-</span>
                        <span class="stat-failed" id="icon-failed-count">0</span>
                        <span class="stat-label">failed</span>
                    </div>
                </div>
                <div class="stat-line">
                    <span class="stat-label">VIDEO:</span>
                    <div class="stat-values">
                        <span class="stat-passed" id="stream-passed-count">0</span>
                        <span class="stat-label">passed</span>
                        <span class="stat-separator">-</span>
                        <span class="stat-failed" id="stream-failed-count">0</span>
                        <span class="stat-label">failed</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="channels-list" class="channels-list">
            <!-- Channels will be inserted here -->
        </div>

        <!-- Hidden video for testing -->
        <video id="test-video" class="hidden" muted playsinline preload="none"></video>

        <a id="debug-button" href="./" style="display: none"><img id="debug-button-icon" alt=""></a>

        <script>
            let channels = [];
            let currentTestIndex = 0;
            let isTesting = false;
            let testHls = null;
            let testTimeout = null;
            let hasGlobalError = false; // NEW: Track if ANY error has occurred

            // Stats counters
            let streamPassedCount = 0;
            let streamFailedCount = 0;
            let idPassedCount = 0;
            let idFailedCount = 0;
            let iconPassedCount = 0;
            let iconFailedCount = 0;

            function updateCurrentStatus(text, type = 'loading') {
                const led = document.getElementById('current-led');
                const textEl = document.getElementById('current-text');

                // If we already have a global error, NEVER change back from red
                if (hasGlobalError && type !== 'error') {
                    led.className = `current-led error`;
                    textEl.textContent = text;
                    return;
                }

                // Update the status
                led.className = `current-led ${type}`;
                textEl.textContent = text;

                // If this is an error, set global error flag
                if (type === 'error') {
                    hasGlobalError = true;
                }
            }

            function updateStats() {
                const total = channels.length;
                const testedCount = currentTestIndex;
                const toBeTested = Math.max(0, total - testedCount);

                // Update progress info
                document.getElementById('progress-info').textContent = `${testedCount}/${total}`;

                // Update stats
                document.getElementById('stream-passed-count').textContent = streamPassedCount;
                document.getElementById('stream-failed-count').textContent = streamFailedCount;
                document.getElementById('id-passed-count').textContent = idPassedCount;
                document.getElementById('id-failed-count').textContent = idFailedCount;
                document.getElementById('icon-passed-count').textContent = iconPassedCount;
                document.getElementById('icon-failed-count').textContent = iconFailedCount;
            }

            function updateChannelStatus(index, type, extraText = '') {
                const channel = channels[index];
                if (!channel) return;

                // Use index-based selector instead of ID-based to handle duplicate IDs
                const cards = document.querySelectorAll('.channel-card');
                if (index >= cards.length) return;

                const card = cards[index];
                const led = card.querySelector('.channel-led');
                const name = card.querySelector('.channel-name');

                if (led) {
                    led.className = `channel-led ${type}`;
                }

                if (name) {
                    if (extraText) {
                        name.textContent = `${channel.name} (${extraText})`;
                    } else {
                        name.textContent = channel.name;
                    }
                }
            }

            function completeTest(streamSuccess, idSuccess, iconSuccess) {
                // Check if ANY of the validations failed
                if (!streamSuccess || !idSuccess || !iconSuccess) {
                    // Set global error flag - once red, stays red forever
                    hasGlobalError = true;
                }

                // Update stream counts
                if (streamSuccess) {
                    streamPassedCount++;
                } else {
                    streamFailedCount++;
                }

                // Update ID counts
                if (idSuccess) {
                    idPassedCount++;
                } else {
                    idFailedCount++;
                }

                // Update icon counts
                if (iconSuccess) {
                    iconPassedCount++;
                } else {
                    iconFailedCount++;
                }

                // Update the channel status display for stream
                // ALWAYS set LED to error if ANY validation failed
                const ledType = (streamSuccess && idSuccess && iconSuccess) ? 'success' : 'error';
                updateChannelStatus(currentTestIndex, ledType);

                // Move to next test
                currentTestIndex++;

                // Update all stats
                updateStats();

                // Use index-based selection for URL and icon highlighting too
                if (!streamSuccess || !iconSuccess) {
                    const channel = channels[currentTestIndex - 1];
                    const cards = document.querySelectorAll('.channel-card');
                    const cardIndex = currentTestIndex - 1;

                    if (cardIndex < cards.length) {
                        const card = cards[cardIndex];

                        // Add red background to the URL div for failed streams
                        if (!streamSuccess) {
                            const urlDiv = card.querySelector('.detail-value.url');
                            if (urlDiv) {
                                urlDiv.style.background = '#442222';
                                urlDiv.style.borderColor = '#ff4444';
                            }
                        }

                        // Add red background for failed icons
                        if (!iconSuccess) {
                            const iconDiv = card.querySelector('.detail-value.icon');
                            if (iconDiv) {
                                iconDiv.style.background = '#442222';
                                iconDiv.style.borderColor = '#ff4444';
                            }
                        }
                    }
                }

                // Update current status LED based on global error flag
                if (hasGlobalError) {
                    // This will ensure the LED stays red
                    const led = document.getElementById('current-led');
                    led.className = 'current-led error';
                }
            }

            function createChannelsList() {
                const container = document.getElementById('channels-list');
                container.innerHTML = '';

                channels.forEach((channel, index) => {
                    const card = document.createElement('div');
                    card.className = 'channel-card';
                    // Use data-index instead of data-channel-id to avoid duplicate ID issues
                    card.dataset.index = index;

                    // Create icon HTML - either an image or fallback
                    let iconHTML = '';
                    if (channel.icon) {
                        iconHTML = `<img class="channel-icon" src="${channel.icon}" alt="" onerror="this.onerror=null; this.parentNode.innerHTML='<div class=\'icon-fallback\'>${channel.name.substring(0,2)}</div>';">`;
                    } else {
                        iconHTML = `<div class="icon-fallback">${channel.name.substring(0,2)}</div>`;
                    }

                    // Add red background if ID is invalid or duplicate
                    const idStyle = channel._idInvalid ? 'style="background: #442222; border-color: #ff4444;"' : '';

                    card.innerHTML = `
            <div class="channel-header">
                ${iconHTML}
                <span class="channel-led waiting"></span>
                <span class="channel-name">${channel.name}</span>
            </div>
            <div class="channel-details">
                <div class="detail-label">ID:</div>
                <div class="detail-value" ${idStyle}>${channel.id}</div>

                <div class="detail-label">Name:</div>
                <div class="detail-value">${channel.name}</div>

                <div class="detail-label">Icon:</div>
                <div class="detail-value icon">${channel.icon || 'No icon'}</div>

                <div class="detail-label">URL:</div>
                <div class="detail-value url">${channel.url}</div>
            </div>
        `;

                    container.appendChild(card);
                });
            }

            function testNextStream() {
                if (isTesting || currentTestIndex >= channels.length) {
                    if (currentTestIndex >= channels.length) {
                        if (hasGlobalError) {
                            updateCurrentStatus('Testing complete with errors!', 'error');
                        } else {
                            updateCurrentStatus('All tests passed successfully!', 'success');
                        }
                    }
                    return;
                }

                const channel = channels[currentTestIndex];
                isTesting = true;

                updateCurrentStatus(`Testing: ${channel.name}`, 'loading');
                updateChannelStatus(currentTestIndex, 'waiting', 'testing...');

                // Clean up previous test
                if (testHls) {
                    testHls.destroy();
                    testHls = null;
                }
                if (testTimeout) {
                    clearTimeout(testTimeout);
                }

                const video = document.getElementById('test-video');
                video.src = '';
                video.load();

                // 5 second timeout
                testTimeout = setTimeout(() => {
                    console.log(`Stream ${channel.id}: Timeout`);
                    testHls?.destroy();

                    // Check ID and Icon for this failed stream
                    const idSuccess = !channel._idInvalid;
                    let iconSuccess = false;

                    // Check icon
                    if (channel.icon) {
                        fetch(channel.icon, { method: 'HEAD' })
                            .then(response => {
                                iconSuccess = response.ok;
                                completeTest(false, idSuccess, iconSuccess);
                                isTesting = false;
                                setTimeout(testNextStream, 300);
                            })
                            .catch(() => {
                                iconSuccess = false;
                                completeTest(false, idSuccess, iconSuccess);
                                isTesting = false;
                                setTimeout(testNextStream, 300);
                            });
                    } else {
                        iconSuccess = false; // No icon = failed
                        completeTest(false, idSuccess, iconSuccess);
                        isTesting = false;
                        setTimeout(testNextStream, 300);
                    }
                }, 5000);

                if (Hls.isSupported()) {
                    testHls = new Hls({
                        enableWorker: false,
                        maxBufferLength: 0,
                        maxMaxBufferLength: 0,
                        manifestLoadingTimeOut: 4000,
                        levelLoadingTimeOut: 4000
                    });

                    testHls.loadSource(channel.url);
                    testHls.attachMedia(video);

                    testHls.on(Hls.Events.MANIFEST_PARSED, () => {
                        clearTimeout(testTimeout);
                        console.log(`Stream ${channel.id}: Success`);

                        // Check ID and Icon for this successful stream
                        const idSuccess = !channel._idInvalid;
                        let iconSuccess = false;

                        // Check icon
                        if (channel.icon) {
                            fetch(channel.icon, { method: 'HEAD' })
                                .then(response => {
                                    iconSuccess = response.ok;
                                    completeTest(true, idSuccess, iconSuccess);
                                    testHls.destroy();
                                    testHls = null;
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                })
                                .catch(() => {
                                    iconSuccess = false;
                                    completeTest(true, idSuccess, iconSuccess);
                                    testHls.destroy();
                                    testHls = null;
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                });
                        } else {
                            iconSuccess = false; // No icon = failed
                            completeTest(true, idSuccess, iconSuccess);
                            testHls.destroy();
                            testHls = null;
                            isTesting = false;
                            setTimeout(testNextStream, 300);
                        }
                    });

                    testHls.on(Hls.Events.ERROR, () => {
                        clearTimeout(testTimeout);
                        console.log(`Stream ${channel.id}: Failed`);

                        // Check ID and Icon for this failed stream
                        const idSuccess = !channel._idInvalid;
                        let iconSuccess = false;

                        // Check icon
                        if (channel.icon) {
                            fetch(channel.icon, { method: 'HEAD' })
                                .then(response => {
                                    iconSuccess = response.ok;
                                    completeTest(false, idSuccess, iconSuccess);
                                    testHls.destroy();
                                    testHls = null;
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                })
                                .catch(() => {
                                    iconSuccess = false;
                                    completeTest(false, idSuccess, iconSuccess);
                                    testHls.destroy();
                                    testHls = null;
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                });
                        } else {
                            iconSuccess = false; // No icon = failed
                            completeTest(false, idSuccess, iconSuccess);
                            testHls.destroy();
                            testHls = null;
                            isTesting = false;
                            setTimeout(testNextStream, 300);
                        }
                    });

                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = channel.url;

                    const onSuccess = () => {
                        clearTimeout(testTimeout);
                        console.log(`Stream ${channel.id}: Success`);

                        // Check ID and Icon for this successful stream
                        const idSuccess = !channel._idInvalid;
                        let iconSuccess = false;

                        // Check icon
                        if (channel.icon) {
                            fetch(channel.icon, { method: 'HEAD' })
                                .then(response => {
                                    iconSuccess = response.ok;
                                    completeTest(true, idSuccess, iconSuccess);
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                })
                                .catch(() => {
                                    iconSuccess = false;
                                    completeTest(true, idSuccess, iconSuccess);
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                });
                        } else {
                            iconSuccess = false; // No icon = failed
                            completeTest(true, idSuccess, iconSuccess);
                            isTesting = false;
                            setTimeout(testNextStream, 300);
                        }
                    };

                    const onError = () => {
                        clearTimeout(testTimeout);
                        console.log(`Stream ${channel.id}: Failed`);

                        // Check ID and Icon for this failed stream
                        const idSuccess = !channel._idInvalid;
                        let iconSuccess = false;

                        // Check icon
                        if (channel.icon) {
                            fetch(channel.icon, { method: 'HEAD' })
                                .then(response => {
                                    iconSuccess = response.ok;
                                    completeTest(false, idSuccess, iconSuccess);
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                })
                                .catch(() => {
                                    iconSuccess = false;
                                    completeTest(false, idSuccess, iconSuccess);
                                    isTesting = false;
                                    setTimeout(testNextStream, 300);
                                });
                        } else {
                            iconSuccess = false; // No icon = failed
                            completeTest(false, idSuccess, iconSuccess);
                            isTesting = false;
                            setTimeout(testNextStream, 300);
                        }
                    };

                    video.addEventListener('loadeddata', onSuccess, { once: true });
                    video.addEventListener('error', onError, { once: true });
                } else {
                    clearTimeout(testTimeout);
                    console.log(`Stream ${channel.id}: HLS not supported`);

                    // Check ID and Icon for this failed stream
                    const idSuccess = !channel._idInvalid;
                    let iconSuccess = false;

                    // Check icon
                    if (channel.icon) {
                        fetch(channel.icon, { method: 'HEAD' })
                            .then(response => {
                                iconSuccess = response.ok;
                                completeTest(false, idSuccess, iconSuccess);
                                isTesting = false;
                                setTimeout(testNextStream, 300);
                            })
                            .catch(() => {
                                iconSuccess = false;
                                completeTest(false, idSuccess, iconSuccess);
                                isTesting = false;
                                setTimeout(testNextStream, 300);
                            });
                    } else {
                        iconSuccess = false; // No icon = failed
                        completeTest(false, idSuccess, iconSuccess);
                        isTesting = false;
                        setTimeout(testNextStream, 300);
                    }
                }
            }

            function startTesting() {
                currentTestIndex = 0;
                isTesting = false;
                streamPassedCount = 0;
                streamFailedCount = 0;
                idPassedCount = 0;
                idFailedCount = 0;
                iconPassedCount = 0;
                iconFailedCount = 0;
                hasGlobalError = false; // Reset error flag
                createChannelsList();
                updateStats(); // Show initial stats
                updateCurrentStatus('Starting tests...', 'loading');
                setTimeout(testNextStream, 1000);
            }

            // Initialize
            document.addEventListener('DOMContentLoaded', () => {
                Promise.resolve([{
                "id": "rai1",
                "name": "Rai 1",
                "url": "https://viamotionhsi.netplus.ch/live/eds/rai1/browser-HLS8/rai1.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/f/fa/Rai_1_-_Logo_2016.svg"
            }, {
                "id": "rai2",
                "name": "Rai 2",
                "url": "https://viamotionhsi.netplus.ch/live/eds/rai2/browser-HLS8/rai2.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/9/99/Rai_2_-_Logo_2016.svg"
            }, {
                "id": "rai3",
                "name": "Rai 3",
                "url": "https://viamotionhsi.netplus.ch/live/eds/rai3/browser-HLS8/rai3.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/4/47/Rai_3_-_Logo_2016.svg"
            }, {
                "id": "rete4",
                "name": "Rete 4",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-r4/r4-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/c/c0/Rete_4_-_Logo_2018.svg"
            }, {
                "id": "canale5",
                "name": "Canale 5",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-c5/c5-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/0/02/Canale_5_-_2018_logo.svg"
            }, {
                "id": "italia1",
                "name": "Italia 1",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-i1/i1-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/c/cc/Italia_1_logo.svg"
            }, {
                "id": "la7",
                "name": "La 7",
                "url": "https://viamotionhsi.netplus.ch/live/eds/la7/browser-HLS8/la7.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/0/02/LA7_-_Logo_2011.svg"
            }, {
                "id": "tv8",
                "name": "TV 8",
                "url": "https://hlslive-web-gcdn-skycdn-it.akamaized.net/TACT/11223/tv8web/master.m3u8?hdnts=st=1764666351~exp=1829466206~acl=/*~hmac=b0e9165b6c55027903ad103c8219f363d8765eb300c0d9a339e9767fc3509556",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/9/9a/TV8_logo.png"
            }, {
                "id": "nove",
                "name": "Nove",
                "url": "https://d31mw7o1gs0dap.cloudfront.net/v1/master/3722c60a815c199d9c0ef36c5b73da68a62b09d1/cc-y5pbi2sq9r609/NOVE_IT.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/2/2d/Nove_-_Logo_2017.svg"
            }, {
                "id": "mediaset20",
                "name": "Mediaset 20",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-lb/lb-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/5/5c/20_Mediaset_2018.svg"
            }, {
                "id": "iris",
                "name": "Iris",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-ki/ki-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/9/98/Iris_logo_2013.svg"
            }, {
                "id": "cielo",
                "name": "Cielo",
                "url": "https://hlslive-web-gcdn-skycdn-it.akamaized.net/TACT/11219/cieloweb/master.m3u8?hdnts=st=1764666351~exp=1829466206~acl=/*~hmac=b0e9165b6c55027903ad103c8219f363d8765eb300c0d9a339e9767fc3509556",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/f/f2/Cielo_TV_logo_2013.svg"
            }, {
                "id": "27",
                "name": "27",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-ts/ts-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/2/26/Twentyseven_logo.svg"
            }, {
                "id": "la7cinema",
                "name": "La7 Cinema",
                "url": "https://viamotionhsi.netplus.ch/live/eds/la7d/browser-HLS8/la7d.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/2/20/LA7_Cinema.svg"
            }, {
                "id": "la5",
                "name": "La 5",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-ka/ka-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/d/da/La5_Mediaset.svg"
            }, {
                "id": "realtime",
                "name": "Real Time",
                "url": "https://d3562mgijzx0zq.cloudfront.net/v1/master/3722c60a815c199d9c0ef36c5b73da68a62b09d1/cc-kizqtzpvvl3i8/Realtime_IT.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/7/7a/Real_Time_logo.svg"
            }, {
                "id": "foodnetwork",
                "name": "Food Network",
                "url": "https://dk3okdd5036kz.cloudfront.net/v1/master/3722c60a815c199d9c0ef36c5b73da68a62b09d1/cc-o4pw0nc02sthz/Foodnetwork_IT.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/0/06/Food_Network_logo.svg"
            }, {
                "id": "cine34",
                "name": "Cine34",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-b6/b6-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/d/d7/Cine34_logo.svg"
            }, {
                "id": "focus",
                "name": "Focus",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-fu/fu-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/d/d0/Focus_channel.png"
            }, {
                "id": "rtl1025",
                "name": "RTL 102.5",
                "url": "https://dd782ed59e2a4e86aabf6fc508674b59.msvdn.net/live/S97044836/tbbP8T1ZRPBL/playlist.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/0/0e/RTL_102.5_logo.svg"
            }, {
                "id": "giallo",
                "name": "Giallo",
                "url": "https://d9fqo6nfqlv2h.cloudfront.net/v1/master/3722c60a815c199d9c0ef36c5b73da68a62b09d1/cc-ulukbrgm1n3yb/Giallo_IT.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/8/8e/Giallo_-_Logo_2014.svg"
            }, {
                "id": "topcrime",
                "name": "Top Crime",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-lt/lt-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/e/e3/Top_Crime_-_Logo_2013.svg"
            }, {
                "id": "italia2",
                "name": "Italia 2",
                "url": "https://live02-seg.msf.cdn.mediaset.net/live/ch-i2/i2-clr.isml/index.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/c/c5/Logo_Italia2.svg"
            }, {
                "id": "raiscuola",
                "name": "Rai Scuola",
                "url": "https://viamotionhsi.netplus.ch/live/eds/raiscuola/browser-HLS8/raiscuola.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/1/11/Rai_Scuola_-_Logo_2017.svg"
            }, {
                "id": "raisport",
                "name": "Rai Sport",
                "url": "https://viamotionhsi.netplus.ch/live/eds/raisport1/browser-HLS8/raisport1.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/b/b3/Rai_Sport_-_Logo_2022.svg"
            }, {
                "id": "raistoria",
                "name": "Rai Storia",
                "url": "https://viamotionhsi.netplus.ch/live/eds/raistoria/browser-HLS8/raistoria.m3u8",
                "icon": "https://upload.wikimedia.org/wikipedia/commons/f/f8/Rai_Storia_-_Logo_2017.svg"
            }])
                    .then(channel_data => {
                        const ids = new Set();
                        const urls = new Set();
                        const icons = new Set();
                        let hasErrors = false;

                        // First pass: Check for duplicate IDs and track them
                        const duplicateIds = new Set();
                        for (const [index, channel] of channel_data.entries()) {
                            if (ids.has(channel.id)) {
                                console.error(`❌ Duplicate ID '${channel.id}' at index ${index}`)
                                hasErrors = true
                                duplicateIds.add(channel.id);
                            }
                            ids.add(channel.id);
                        }

                        // Second pass: Validate all channels and mark invalid/duplicate IDs
                        for (const [index, channel] of channel_data.entries()) {
                            // check valid json structure
                            if (!channel.id || !channel.name || !channel.url || !channel.icon) {
                                console.error(`❌ Channel at index ${index} is missing fields:`, channel)
                                hasErrors = true
                            }

                            // Mark channel if ID is duplicate
                            if (duplicateIds.has(channel.id)) {
                                channel._idInvalid = true; // Mark for red background
                            }

                            // Check for invalid characters in ID
                            if (channel.id) {
                                let idInvalid = false;
                                if (!/^[a-z0-9_]+$/.test(channel.id)) {
                                    console.warn(`⚠️ Channel ID '${channel.id}' at index ${index} contains invalid characters. Only lowercase letters, numbers 0-9, and underscores are allowed.`);
                                    hasErrors = true;
                                    idInvalid = true;
                                } else if (channel.id.startsWith('_') || channel.id.endsWith('_')) {
                                    console.warn(`⚠️ Channel ID '${channel.id}' at index ${index} should not start or end with an underscore`);
                                    hasErrors = true;
                                    idInvalid = true;
                                } else if (channel.id.includes('__')) {
                                    console.warn(`⚠️ Channel ID '${channel.id}' at index ${index} should not contain consecutive underscores`);
                                    hasErrors = true;
                                    idInvalid = true;
                                }

                                // Mark channel if ID is invalid
                                if (idInvalid && !channel._idInvalid) {
                                    channel._idInvalid = true;
                                }
                            }

                            // Check duplicate URLs
                            if (urls.has(channel.url)) {
                                console.warn(`⚠️ Duplicate URL in channel '${channel.id}': ${channel.url}`);
                                hasErrors = true
                            }
                            urls.add(channel.url);

                            // Check duplicate icons
                            if (icons.has(channel.icon)) {
                                console.warn(`⚠️ Duplicate ICON in channel '${channel.id}': ${channel.icon}`);
                                hasErrors = true
                            }
                            icons.add(channel.icon);
                        }

                        // success message if there are no errors
                        if (!hasErrors) {
                            console.log(`✅ Validated ${channel_data.length} channels`);
                        }
                        return channel_data
                    })
                    .then(data => {
                        channels = data;
                        updateStats(); // Show stats instantly
                        updateCurrentStatus(`Loaded ${channels.length} streams`, 'success');
                        createChannelsList(); // Call this before startTesting to show colored IDs
                        startTesting();
                    })
                    .catch(error => {
                        console.error('Failed to load channels:', error);
                        updateCurrentStatus(`Error: ${error.message}`, 'error');
                        document.getElementById('channels-list').innerHTML = 
                            `<div style="text-align: center; padding: 40px; color: #ff6b6b;">
                        Error loading channels.json: ${error.message}
                            </div>`;
                    });
            });
        </script>
    </body>
</html>
